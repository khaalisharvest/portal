# ============================================================================
# Khaalis Harvest Platform - Docker Compose Configuration
# ============================================================================
# Architecture:
# - Monorepo: NestJS Backend (port 3000) + Next.js Frontend (port 3001)
# - PostgreSQL Database (port 5432 internally, 5433 externally)
# - Redis Cache (port 6379)
# - Works for both local development and Azure production
# ============================================================================

services:
  # ==========================================================================
  # PostgreSQL Database
  # ==========================================================================
  postgres:
    image: postgres:15-alpine
    container_name: khaalis-postgres
    environment:
      POSTGRES_DB: ${DB_NAME:-khaalis_harvest}
      POSTGRES_USER: ${DB_USERNAME:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-password}
    # Expose port for local development (doesn't hurt in production)
    ports:
      - "${DB_PORT:-5433}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - khaalis-network
    restart: unless-stopped
    # Memory optimization (set POSTGRES_COMMAND in .env for Azure)
    # Default: standard postgres (for local dev)
    # Example for Azure: postgres -c shared_buffers=128MB -c effective_cache_size=256MB -c max_connections=50
    command: ${POSTGRES_COMMAND:-postgres}
    # Health check for PostgreSQL
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-postgres} -d ${DB_NAME:-khaalis_harvest}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ==========================================================================
  # Redis Cache
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: khaalis-redis
    # Expose port for local development (doesn't hurt in production)
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - khaalis-network
    restart: unless-stopped
    # Memory optimization (set REDIS_COMMAND in .env for Azure)
    # Default: standard redis-server (for local dev)
    # Example for Azure: redis-server --maxmemory 128mb --maxmemory-policy allkeys-lru
    command: ${REDIS_COMMAND:-redis-server}
    # Health check for Redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ==========================================================================
  # Application Container (Backend + Frontend)
  # ==========================================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Build-time environment variables (needed during Docker build)
        # Next.js embeds NEXT_PUBLIC_* vars into client bundle at build time
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
        NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL}
        NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-}
        BACKEND_URL: ${BACKEND_URL}
        JWT_SECRET: ${JWT_SECRET}
        NEXT_PUBLIC_ADMIN_EMAIL: ${NEXT_PUBLIC_ADMIN_EMAIL}
        NEXT_PUBLIC_ADMIN_WHATSAPP: ${NEXT_PUBLIC_ADMIN_WHATSAPP}
        NEXT_PUBLIC_BANK_NAME: ${NEXT_PUBLIC_BANK_NAME}
        NEXT_PUBLIC_BANK_ACCOUNT_NAME: ${NEXT_PUBLIC_BANK_ACCOUNT_NAME}
        NEXT_PUBLIC_BANK_ACCOUNT_NUMBER: ${NEXT_PUBLIC_BANK_ACCOUNT_NUMBER}
        NEXT_PUBLIC_BANK_IBAN: ${NEXT_PUBLIC_BANK_IBAN}
        NEXT_PUBLIC_APP_NAME: ${NEXT_PUBLIC_APP_NAME}
        NEXT_PUBLIC_APP_DESCRIPTION: ${NEXT_PUBLIC_APP_DESCRIPTION}
        NEXT_PUBLIC_DEFAULT_CURRENCY: ${NEXT_PUBLIC_DEFAULT_CURRENCY}
        NEXT_PUBLIC_DEFAULT_LANGUAGE: ${NEXT_PUBLIC_DEFAULT_LANGUAGE}
        NODE_ENV: ${NODE_ENV:-production}
    container_name: khaalis-app
    # Load all environment variables from .env file (single source of truth)
    env_file:
      - .env
    environment:
      # Override Docker-specific values (container-to-container communication)
      # These MUST be set here because they differ from .env values
      DB_HOST: postgres  # Docker service name (not localhost)
      DB_PORT: 5432       # Internal Docker port (not host port 5433)
      REDIS_HOST: redis  # Docker service name (not localhost)
      
      # Memory optimization (set NODE_OPTIONS_BACKEND/FRONTEND in .env for Azure)
      # Defaults: Higher memory for local dev, can be reduced for Azure
      # Format: MB value (e.g., 1536 = 1.5GB)
      NODE_OPTIONS_BACKEND: ${NODE_OPTIONS_BACKEND:-1536}
      NODE_OPTIONS_FRONTEND: ${NODE_OPTIONS_FRONTEND:-2048}
    ports:
      - "3000:3000"  # Backend API
      - "3001:3001"  # Frontend Web App
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - khaalis-network
    restart: unless-stopped

# ============================================================================
# Volumes (persistent data storage)
# ============================================================================
volumes:
  postgres_data:
    # PostgreSQL data persists here
  redis_data:
    # Redis data persists here

# ============================================================================
# Networks (container-to-container communication)
# ============================================================================
networks:
  khaalis-network:
    driver: bridge
    # All containers communicate via this network
    # Use service names (postgres, redis) as hostnames
